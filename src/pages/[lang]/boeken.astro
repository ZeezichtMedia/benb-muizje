---
import Layout from '../../layouts/Layout.astro';
import Navbar from '../../components/common/Navbar.astro';
import Footer from '../../components/common/Footer.astro';
import { useTranslations } from '../../i18n/ui';
import AvailabilityCalendar from '../../components/booking/AvailabilityCalendar';
import { getRelativeLocaleUrl } from "astro:i18n";

export function getStaticPaths() {
  const languages = ['en', 'de'];
  return languages.map((lang) => ({ params: { lang } }));
}

const { lang } = Astro.params;
const currentLang = (lang as 'nl' | 'en' | 'de') || 'nl';
const t = useTranslations(currentLang);

const content = {
  nl: { title: "Reserveren", intro: "Kies uw data en stel uw ideale verblijf samen." },
  en: { title: "Booking", intro: "Select dates and customize your stay." },
  de: { title: "Buchen", intro: "Wählen Sie Ihre Daten und gestalten Sie Ihren Aufenthalt." }
};

const c = content[currentLang];
---

<Layout title={`Zeeuwse Buurn | ${c.title}`} lang={currentLang}>
  <Navbar />
  <div class="pt-24 md:pt-36 pb-12 bg-brand-light min-h-screen">
    <div class="max-w-7xl mx-auto px-6">
        <!-- Header -->
        <div class="text-center max-w-3xl mx-auto mb-16">
            <h1 class="text-4xl md:text-5xl font-heading font-black text-brand-green mb-6 animate-slide-up">{c.title}</h1>
            <p class="text-lg text-brand-dark/70 leading-relaxed animate-slide-up delay-100">{c.intro}</p>
        </div>

        <div class="max-w-4xl mx-auto space-y-16">
            
            <!-- 1. Calendar (Full Width) -->
            <div class="animate-slide-up delay-200">
                <AvailabilityCalendar client:load lang={currentLang} />
            </div>

            <!-- 2. Booking Form -->
            <div id="booking-form-container" class="bg-white p-8 md:p-12 rounded-[2.5rem] shadow-xl border border-brand-clay/20 animate-slide-up delay-300 relative overflow-hidden transition-all duration-500">
                <h2 class="text-3xl font-heading font-bold text-brand-green mb-8 text-center">{c.title}</h2>

                <!-- Selected Dates Summary -->
                <div class="bg-brand-green/5 border border-brand-green/20 rounded-2xl p-6 mb-8 text-center">
                    <p class="text-brand-dark/60 text-sm font-bold uppercase tracking-wide mb-2">
                        {currentLang === 'nl' ? 'Geselecteerde Periode' : (currentLang === 'de' ? 'Gewählter Zeitraum' : 'Selected Period')}
                    </p>
                    <p id="date-summary" class="text-2xl md:text-3xl font-heading font-bold text-brand-green">
                        -
                    </p>
                    <p class="text-xs text-brand-dark/50 mt-2 italic">
                        {currentLang === 'nl' ? '(Kies eerst data in de kalender hierboven)' : (currentLang === 'de' ? '(Wählen Sie zuerst Daten im Kalender oben)' : '(First select dates in the calendar above)')}
                    </p>
                </div>

                <form name="booking" method="POST" data-netlify="true" class="space-y-6">
                    
                    <!-- Hidden Date Inputs -->
                    <input type="hidden" id="checkin" name="checkin" required />
                    <input type="hidden" id="checkout" name="checkout" required />

                    <!-- Personal Details -->
                    <div class="space-y-4">
                        <input type="text" name="name" placeholder={t('form.name')} required class="w-full px-6 py-4 rounded-xl bg-brand-light border-transparent focus:border-brand-green focus:bg-white focus:ring-0 transition-colors text-lg" />
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                             <input type="email" name="email" placeholder={t('form.email')} required class="w-full px-6 py-4 rounded-xl bg-brand-light border-transparent focus:border-brand-green focus:bg-white focus:ring-0 transition-colors text-lg" />
                             <input type="tel" name="phone" placeholder={t('form.phone')} required class="w-full px-6 py-4 rounded-xl bg-brand-light border-transparent focus:border-brand-green focus:bg-white focus:ring-0 transition-colors text-lg" />
                        </div>
                    </div>

                    <!-- Guest Details -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label for="guests" class="block text-sm font-bold text-brand-dark pl-2">{t('form.guests')}</label>
                            <select id="guests" name="guests" class="w-full px-6 py-4 rounded-xl bg-brand-light border-transparent focus:border-brand-green focus:bg-white focus:ring-0 transition-colors text-lg appearance-none">
                                <option value="1">1</option>
                                <option value="2" selected>2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label for="age_oldest" class="block text-sm font-bold text-brand-dark pl-2">{t('form.age_oldest')}</label>
                            <input type="number" id="age_oldest" name="age_oldest" min="18" required class="w-full px-6 py-4 rounded-xl bg-brand-light border-transparent focus:border-brand-green focus:bg-white focus:ring-0 transition-colors text-lg" />
                        </div>
                    </div>
                
                    <!-- Pet -->
                    <div class="space-y-3">
                        <span class="block text-sm font-bold text-brand-dark pl-2">{t('form.pet')}</span>
                        <div class="flex gap-6 pl-2">
                             <label class="flex items-center gap-3 cursor-pointer group">
                                 <div class="relative flex items-center">
                                     <input type="radio" name="pet" value="yes" class="peer sr-only" />
                                     <div class="w-6 h-6 border-2 border-brand-clay/30 rounded-full peer-checked:border-brand-green peer-checked:bg-brand-green transition-all"></div>
                                 </div>
                                 <span class="text-lg text-brand-dark group-hover:text-brand-green transition-colors">{t('form.yes')}</span>
                             </label>
                             <label class="flex items-center gap-3 cursor-pointer group">
                                 <div class="relative flex items-center">
                                     <input type="radio" name="pet" value="no" checked class="peer sr-only" />
                                     <div class="w-6 h-6 border-2 border-brand-clay/30 rounded-full peer-checked:border-brand-green peer-checked:bg-brand-green transition-all"></div>
                                 </div>
                                 <span class="text-lg text-brand-dark group-hover:text-brand-green transition-colors">{t('form.no')}</span>
                             </label>
                        </div>
                    </div>

                    <!-- Remarks -->
                    <textarea name="remarks" rows="3" placeholder={t('form.remarks')} class="w-full px-6 py-4 rounded-xl bg-brand-light border-transparent focus:border-brand-green focus:bg-white focus:ring-0 transition-colors text-lg"></textarea>
                    
                    <!-- Disclaimer -->
                    <p class="text-sm text-brand-dark/70 italic text-center">
                        {t('form.disclaimer')}
                    </p>

                    <button type="submit" class="w-full bg-brand-green text-white font-bold text-xl py-5 rounded-full shadow-lg hover:bg-brand-dark hover:scale-[1.02] active:scale-95 transition-all duration-300">
                        {t('form.send')}
                    </button>
                </form>
            </div>
        </div>
    </div>
  </div>
  <Footer />
</Layout>

<script define:vars={{ currentLang }}>
    document.addEventListener('DOMContentLoaded', function() {
        const formContainer = document.getElementById('booking-form-container');
        const summaryElement = document.getElementById('date-summary');
        const checkinInput = document.getElementById('checkin');
        const checkoutInput = document.getElementById('checkout');

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString(currentLang === 'nl' ? 'nl-NL' : (currentLang === 'de' ? 'de-DE' : 'en-US'), {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }

        // Listen for calendar selection
        window.addEventListener('booking-dates-selected', ((e) => {
            const { start, end } = e.detail;
            
            if (start && end) {
                const startObj = new Date(start);
                const endObj = new Date(end);

                const formatISO = (d) => {
                    const offset = d.getTimezoneOffset();
                    const local = new Date(d.getTime() - (offset*60*1000));
                    return local.toISOString().split('T')[0];
                };

                checkinInput.value = formatISO(startObj);
                checkoutInput.value = formatISO(endObj);

                summaryElement.innerText = `${formatDate(start)}  —  ${formatDate(end)}`;

                formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }));
    });
</script>
